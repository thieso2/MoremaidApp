[tools]
tuist = "latest"

[vars]
app_name = "Moremaid"
scheme = "Moremaid"
workspace = "Moremaid.xcworkspace"
destination = "platform=macOS"
derived_data = ".derivedData"
app_bundle = "Moremaid.app"

[tasks.setup]
description = "Install dependencies and generate Xcode project"
depends = ["install"]
run = "tuist generate --no-open"

[tasks.generate]
description = "Generate Xcode project from Tuist"
run = "tuist generate --no-open"

[tasks.build]
description = "Build the app"
depends = ["_ensure-workspace"]
run = """
tuist xcodebuild -workspace {{vars.workspace}} \
  -scheme {{vars.scheme}} \
  -destination '{{vars.destination}}' \
  -derivedDataPath {{vars.derived_data}} \
  build
"""

[tasks.debug]
description = "Build and run the app in the foreground"
depends = ["build"]
run = "{{vars.derived_data}}/Build/Products/Debug/{{vars.app_bundle}}/Contents/MacOS/{{vars.app_name}}"

[tasks.clean]
description = "Clean build and DerivedData"
run = """
rm -rf {{vars.derived_data}}
echo "DerivedData cleaned"
"""

[tasks."clean-build"]
description = "Clean DerivedData and rebuild from scratch"
depends = ["clean", "install", "generate"]
run = """
tuist xcodebuild -workspace {{vars.workspace}} \
  -scheme {{vars.scheme}} \
  -destination '{{vars.destination}}' \
  -derivedDataPath {{vars.derived_data}} \
  build 2>&1 | tail -5
"""

[tasks.run]
description = "Build and run the app"
depends = ["build"]
run = """
# Kill existing instance
pkill -9 -f '{{vars.app_bundle}}/Contents/MacOS/{{vars.app_name}}' 2>/dev/null || true
sleep 0.5

# Find the built binary
APP=$(find {{vars.derived_data}} -path "*/Debug/{{vars.app_bundle}}/Contents/MacOS/{{vars.app_name}}" -type f 2>/dev/null | head -1)

if [ -z "$APP" ]; then
  echo "Error: built binary not found"
  exit 1
fi

echo "Launching $APP"
"$APP" &
echo "{{vars.app_name}} launched"
"""

[tasks.stop]
description = "Stop the running app"
run = """
pkill -9 -f '{{vars.app_bundle}}/Contents/MacOS/{{vars.app_name}}' 2>/dev/null && \
  echo "{{vars.app_name}} stopped" || \
  echo "{{vars.app_name}} not running"
"""

[tasks.restart]
description = "Stop, rebuild, and run"
depends = ["stop", "build"]
run = """
APP=$(find {{vars.derived_data}} -path "*/Debug/{{vars.app_bundle}}/Contents/MacOS/{{vars.app_name}}" -type f 2>/dev/null | head -1)
"$APP" &
echo "{{vars.app_name}} launched"
"""

[tasks.test]
description = "Run unit tests"
depends = ["_ensure-workspace"]
run = """
tuist xcodebuild -workspace {{vars.workspace}} \
  -scheme {{vars.scheme}} \
  -destination '{{vars.destination}}' \
  -derivedDataPath {{vars.derived_data}} \
  test 2>&1 | grep -E '(Test Suite|Test Case|Executed|FAILED|PASSED|BUILD)' | tail -20
"""

[tasks.log]
description = "Tail the debug log"
run = "tail -f /tmp/moremaid-debug.log 2>/dev/null || echo 'No debug log found'"

[tasks.dist]
description = "Copy built app bundle to .build/"
depends = ["build"]
run = """
APP_SRC=$(find {{vars.derived_data}} -path "*/Debug/{{vars.app_bundle}}" -type d -maxdepth 5 2>/dev/null | head -1)

if [ -z "$APP_SRC" ]; then
  echo "Error: built app not found in DerivedData"
  exit 1
fi

mkdir -p .build
rm -rf .build/{{vars.app_bundle}}
cp -R "$APP_SRC" .build/{{vars.app_bundle}}
echo "Copied to .build/{{vars.app_bundle}}"
"""

[tasks.install]
description = "Install Tuist dependencies"
run = "tuist install"

[tasks._ensure-workspace]
description = "Run setup if workspace is missing"
hide = true
run = """
if [ ! -d "{{vars.workspace}}" ]; then
  echo "Workspace missing â€” running setup..."
  tuist install && tuist generate --no-open
fi
"""
